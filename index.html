<!DOCTYPE html>
<html>
  <head>
    <!--script src="js/build/react-with-addons.js"></script>
    <script src="js/build/JSXTransformer.js"></script-->
    <script src="js/snap.svg-min.js"></script>
    <script src="taiwan_railways.js"></script>

    <style>
    </style>
  </head>
  <body>
    <div id="svg"></div>
    <script>
    function parseArray(railwaysList) {
      return railwaysList.map(function(railway) {
        return railway.map(function(r) {
          return [r[0], r[1], r[2], r[3], {x: (r[4][0] + r[4][2]) / 2, y: (r[4][1] + r[4][3]) / 2}]
        })
      });
    }
    window.onload = function () {
      var rlines = [];
      var s = Snap(600, 600);
      var k = 0;
      var dot = [];
      var railNum = s.text(25, 25, k);
      railways = parseArray(railways);
      var drawIt = function(n) {
        if (!(k >= 0 && k < railways.length)) {
          return;
        }
        k+=n;

        railNum.remove();
        railNum = s.text(25, 25, k.toString());
        var railway = railways[k];

        for (var j = 1; j < railway.length; j++) {
          var r_exist = false
          var ele = railway[j - 1];
          var coords = ele[4];
          var x = coords.x;
          var y = coords.y;
          var prev = railway[j];
          var px = prev[4].x;
          var py = prev[4].y;
          r_exist = !!rlines[j - 1];

          if (!r_exist) {
            rlines[j - 1] = s.line(x, y, x, y);
            rlines[j - 1].attr({
              strokeWidth: 2,
              stroke: "#000",
              "stroke-opacity": 0.5
            });
            rlines[j - 1].animate({
              x2: px,
              y2: py
            }, 200);
          }
          else {
            rlines[j - 1].animate({
              x1: x,
              y1: y,
              x2: px,
              y2: py,
              stroke: "#00ff00"
            }, 200)
          }
        }
        for (var jj = j - 1; jj < rlines.length; jj++) {
          rlines[jj].animate({
            opacity: 0.1
          }, 200, null, function() {
            this.remove();
          }.bind(rlines[jj]));
        }

        for (var i = 0; i < railway.length; i++) {
          var dot_exist = false
          var ele = railway[i];
          var coords = ele[4];
          var x = coords.x;
          var y = coords.y;
          dot_exist = !!dot[i];
          if (!dot_exist) {
            dot[i] = s.circle(x, y, 1);
            dot[i].animate({r: 5}, (200 * Math.min(railway.length - i, dot.length - i)), function(i) {
              this.attr({ fill: ((i === (railway.length - 1)) ? "#ffff00" : "#ff0000"), stroke: "#000", strokeWidth: 2, "stroke-opacity": 0.5 });
            }.bind(dot[i], i) );
          }
          else {
            dot[i].animate({
              cx: x,
              cy: y
            }, 220, function(i) {
              // if (i === railway.length - 1) {
              this.attr({ fill: ((i === (railway.length - 1)) ? "#ffff00" : "#ff0000") });
              // }
            }.bind(dot[i], i));
          }
        }

        for (var ii = i; ii < dot.length; ii++) {
          // if (ii === i) {

          // }
          dot[ii].animate({
            opacity: 0.1,
            r: 1
          }, 220, null, function() {
            this.remove();
          }.bind(dot[ii]));
        }
      };
      window.addEventListener("keyup", function(e) {
        if (e.keyCode === 37) {
          drawIt(-1);
        }
        if (e.keyCode === 39) {
          drawIt(1);
        }
      }, false);
      drawIt(0);
    };
    </script>
  </body>
</html>
